---
title: "COVID19 Time Series Analysis, Worldwide and U.S."
author: "Andy Hasselwander"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
---

Source data: 2019 Novel Coronavirus COVID-19 (2019-nCoV) Data Repository by Johns Hopkins CSSE; https://github.com/CSSEGISandData/COVID-19

Source code: https://github.com/opencedar/covid19

The visualizations in this document are heavily indebted to Edward Tufte and his use of sparklines—small, clutter-free time series lines—to show how many different panels or categories of data are changing through time; check out https://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0001OR. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

####HOPKINS DATABASE####

# Get deaths, confirmed, recovered by country, region by date. These are three separate databases 

#------------------------------------------------------------------------------------------------
rm(list = ls())
library(tidyverse)
library(zoo)
library(scales)
source("functions.R")

daily_vector <- seq(from = as.Date("2020-01-22"), (lubridate::today()-1), "day")
daily_vector <- format(daily_vector, "%m-%d-%Y")

for(i in 1:length(daily_vector)) {
  day_get <- daily_vector[i]
  if(i==1) {
    hopkins_df <- read.csv(paste0("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/", daily_vector[i],".csv"))
    hopkins_df <- data.frame(date = rep(day_get, times = nrow(hopkins_df)), hopkins_df) 
    colnames(hopkins_df) <- gsub("\\.", "_", colnames(hopkins_df))
  } else {
    df <- read.csv(paste0("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/", daily_vector[i],".csv"))
    df <- data.frame(date = rep(day_get, times = nrow(df)), df) 
    colnames(df) <- gsub("\\.", "_", colnames(df))
    hopkins_df <- bind_rows(hopkins_df, df)
  }
}
hopkins_df$date <- lubridate::mdy(hopkins_df$date)
hopkins_df$Last_Update <- lubridate::mdy_hms(hopkins_df$Last_Update)



state_key_o <- read.csv("https://raw.githubusercontent.com/jasonong/List-of-US-States/master/states.csv", stringsAsFactors = FALSE)
state <- data.frame(State = state_key_o$State, Abbreviation = state_key_o$State)
state_key <- rbind(state_key_o, state)

x <- hopkins_df

#Fix China, Iran
x$Country_Region[x$Country_Region == "Mainland China"] <- "China"
x$Country_Region[x$Country_Region == "Iran (Islamic Republic of)"] <- "Iran"
x$Country_Region[x$Country_Region == "Republic of Korea"] <- "Korea, South"
x$Country_Region[x$Country_Region == "South Korea"] <- "Korea, South"


x$state_from_county <- str_extract(x$Province_State, '(A[LKSZR])|(C[AOT])|(D[EC])|(F[ML])|(G[AU])|(HI)|(I[DLNA])|(K[SY])|(LA)|(M[EHDAINSOT])|(N[EVHJMYCD])|(MP)|(O[HKR])|(P[WAR])|(RI)|(S[CD])|(T[NX])|(UT)|(V[TIA])|(W[AVIY])')
x <- merge(x, state_key, all.x=TRUE, all.y = FALSE, by.x = 'state_from_county', by.y = "Abbreviation")
x$Province_State[!is.na(x$State)] <- x$State[!is.na(x$State)] 

x <- x %>% select(colnames(hopkins_df))


covid_ets <- x %>% group_by( Country_Region, Province_State, date) %>% summarise(confirmed = sum(Confirmed, na.rm=TRUE), deaths = sum(Deaths, na.rm=TRUE), recovered = sum(Recovered, na.rm = TRUE), active = sum(Active))

write.csv(covid_ets, "covid_ets.csv")

#covid_country_ets data set is the primary country-level time series data set
covid_country_ets <- covid_ets  %>% 
  group_by(Country_Region, date) %>% 
  summarise(confirmed = sum(confirmed, na.rm=TRUE), deaths = sum(deaths, na.rm=TRUE), recovered = sum(recovered, na.rm = TRUE)) %>% 
  mutate(
    #create daily percent growth variables
    confirmed_growth_rate = c(NA,diff(confirmed))/lag(confirmed, 1),
    death_growth_rate = c(NA,diff(deaths))/lag(deaths, 1),
    death_rate = deaths / confirmed,
    active = confirmed - deaths,
    active_lag14 = dplyr::lag(confirmed - deaths, 14, 0),
    active_lag7 = dplyr::lag(confirmed - deaths, 7, 0),
    confirmed_lag7 = dplyr::lag(confirmed, 7, 0),
    confirmed_lag14 = dplyr::lag(confirmed, 14, 0),
    new_confirmed = c(NA, diff(confirmed)),
    new_deaths = c(NA, diff(deaths)),
    new_confirmed_lag7 = dplyr::lag(new_confirmed,7,0),
    new_confirmed_lag14 = dplyr::lag(new_confirmed,14,0),
    new_confirmed_ma7 = rollmean(x=new_confirmed, 7, fill=NA, align = "right"),
    new_confirmed_ma14 = rollmean(x=new_confirmed, 14, fill=NA, align="right")
  )

#replace NaNs w 0s
covid_country_ets$confirmed_growth_rate[is.nan(covid_country_ets$confirmed_growth_rate)] <- 0
covid_country_ets$death_growth_rate[is.nan(covid_country_ets$death_growth_rate)] <- 0

#create country 
covid_country_ets <- covid_country_ets %>% mutate(
  conf_growth_rate_ma=rollapply(confirmed_growth_rate,5,mean,align='right',fill=NA),
  death_growth_rate_ma=rollapply(death_growth_rate,5,mean,align='right',fill=NA)) %>%
  ungroup()

#Filter out growth w < 100 base
covid_country_ets$conf_growth_rate_ma[covid_country_ets$confirmed <100] <- NA
covid_country_ets$death_growth_rate_ma[covid_country_ets$deaths <100] <- NA
covid_country_ets$death_rate[covid_country_ets$deaths <100] <- NA

#make rows with confimed cases and NA new_confirmed have 0 not NA new_confirmed
covid_country_ets$new_confirmed[is.na(covid_country_ets$new_confirmed) & !is.na(covid_country_ets$confirmed)] <- 0


#Only get countries with >1000 cases today
current_cases <- covid_country_ets %>% group_by(Country_Region) %>% summarise(current_cases = max(confirmed, na.rm=TRUE))
five_hundred <- current_cases$Country_Region[current_cases$current_cases >= 1000]

covid_country_ets <- covid_country_ets %>% filter(Country_Region %in% five_hundred)

#Create a panel data set
library(plm)
covid_plm <- pdata.frame(covid_country_ets, index=c("Country_Region", "date"))
#create diff variables
covid_plm$diff_confirmed <- diff(covid_plm$confirmed, 1)
covid_plm$diff_deaths <- diff(covid_plm$deaths, 1)


#######
```
# Worldwide

## Worldwide Summary

Sorted by total number of cases. Percent growth in total cases in the past seven days is last column.
```{r echo=FALSE, message=FALSE, warning=FALSE}

covid_country_fc <- data.frame(covid_country_ets)
#Only get country-days with >= 100 cases
covid_country_fc <- covid_country_fc %>% filter(confirmed >= 100)
covid_country_fc <- covid_country_fc %>% group_by(Country_Region) %>% mutate(days_since_100 = dplyr::row_number())

# Create NA versions of variables
covid_country_fc$deaths_na <- covid_country_fc$deaths
covid_country_fc$deaths_na[covid_country_fc$deaths_na <= 0] <- NA
covid_country_fc$confirmed_na <- covid_country_fc$confirmed
covid_country_fc$confirmed_na[covid_country_fc$confirmed_na <= 0] <- NA
covid_country_fc$days_since_100_na <- covid_country_fc$days_since_100
covid_country_fc$days_since_100_na[covid_country_fc$days_since_100_na <= 0] <- NA
covid_country_fc$confirmed_lag7_na <- covid_country_fc$confirmed_lag7
covid_country_fc$confirmed_lag7_na[covid_country_fc$confirmed_lag7_na <= 0] <- NA
covid_country_fc$confirmed_lag14_na <- covid_country_fc$confirmed_lag14
covid_country_fc$confirmed_lag14_na[covid_country_fc$confirmed_lag14_na <= 0] <- NA
covid_country_fc$new_confirmed_lag7_na <- covid_country_fc$new_confirmed_lag7
covid_country_fc$new_confirmed_lag7_na[covid_country_fc$new_confirmed_lag7_na <= 0] <- NA
covid_country_fc$new_confirmed_lag14_na <- covid_country_fc$new_confirmed_lag14
covid_country_fc$new_confirmed_lag14_na[covid_country_fc$new_confirmed_lag14_na <= 0] <- NA
covid_country_fc$new_confirmed_na <- covid_country_fc$new_confirmed
covid_country_fc$new_confirmed_na[covid_country_fc$new_confirmed_na <= 0] <- NA
covid_country_fc$new_confirmed_ma7_na <- covid_country_fc$new_confirmed_ma7
covid_country_fc$new_confirmed_ma7_na[covid_country_fc$new_confirmed_ma7_na <= 0] <- NA
covid_country_fc$new_confirmed_ma14_na <- covid_country_fc$new_confirmed_ma14
covid_country_fc$new_confirmed_ma14_na[covid_country_fc$new_confirmed_ma14_na <= 0] <- NA

#create country summary
country_summary <- covid_country_fc %>%
  group_by(Country_Region) %>% 
  slice(which.max(days_since_100)) %>% 
  select(Country_Region, days_100 = days_since_100, conf = confirmed, deaths, new_conf=new_confirmed, conf_lag7=confirmed_lag7) %>%
  arrange(desc(conf))

#create worldwide totals
world <- data.frame(Country_Region = "World", 
                    days_100 = mean(country_summary$days_100),
                    conf = sum(country_summary$conf),
                    deaths = sum(country_summary$deaths),
                    new_conf = sum(country_summary$new_conf),
                    conf_lag7 = sum(country_summary$conf_lag7))

country_summary <- bind_rows(country_summary, world)   

country_summary <- country_summary %>% mutate(l7_rate = (conf / conf_lag7)-1)

country_summary$l7_rate <- scales::percent(country_summary$l7_rate, accuracy = 4, big.mark = ",")


knitr::kable(country_summary, caption = "Worldwide Summary", digits  = 0, align = c("l",rep("r", times = 7)))

```

## Ln (Seven-Day-Moving-Average New Cases) Impact on Ln (New Cases)

In other words, elasticity. How does this elasticity change through time, from days since the 100th case?

An elasticity under 1 indicates that over a seven-day period, new cases are decreasing.

The black line shows the best curve fit for elasticity changing over time. All countries generally are moving to cap the rate of exponential growth. Countries above the line are doing worse than average, and those below the line are doing better than average. A rate below 1 indicates that new cases are declining over an average 7-day period.

```{r echo = FALSE, message=FALSE, warning=FALSE}
library(broom)
#Remove NAs

confirmed_models <- covid_country_fc %>% group_by(Country_Region) %>% do(model = lm(log(new_confirmed_na) ~  log(new_confirmed_ma7_na) -1, data = .))
confirmed_tidy_model <- confirmed_models %>% tidy(model)

days_since_100_by_country <- covid_country_fc %>% group_by(Country_Region) %>% summarize(days_since_100 = max(days_since_100))

seven_day_elasticity_by_country <- data.frame(country = confirmed_tidy_model$Country_Region, days_since_100  = as.numeric(days_since_100_by_country$days_since_100), lag_7_elasticity = confirmed_tidy_model$estimate)


cases_7_day_model_ww <- lm(lag_7_elasticity ~ log(days_since_100),data = seven_day_elasticity_by_country)

seven_day_elasticity_by_country$prediction <-  cases_7_day_model_ww$coefficients[[1]] + cases_7_day_model_ww$coefficients[[2]] * log(seven_day_elasticity_by_country$days_since_100)

seven_day_elasticity_by_country_no_outliers <- seven_day_elasticity_by_country %>% filter(lag_7_elasticity <2)

require(ggrepel)
ggplot(seven_day_elasticity_by_country_no_outliers, aes(x=days_since_100)) +
  geom_point(shape=1, show.legend = FALSE, (aes(y=lag_7_elasticity, color = country))) +    # Use hollow circles
  geom_line(aes( y = prediction)) +
  geom_label_repel(data=  seven_day_elasticity_by_country_no_outliers, aes(x=days_since_100, y=lag_7_elasticity, label = country), size=2) + 
  theme(legend.position = "none") 

knitr::kable(seven_day_elasticity_by_country_no_outliers %>% mutate(residual = lag_7_elasticity - prediction) %>% arrange(days_since_100, residual), caption = "Countries by Predicted vs. Actual Lag 7 New Case Elasticity on Today's Cases", digits = 2)

actuals <- covid_country_fc %>% select(country = Country_Region, date, days_since_100 = days_since_100, confirmed, new_confirmed, new_confirmed_lag7)

prediction <- expand.grid(country = unique(seven_day_elasticity_by_country$country), days_since_100 = 1:100) %>% 
  arrange(country, days_since_100)

prediction$prediction <- predict.lm(cases_7_day_model_ww, prediction)

prediction <- merge(prediction, actuals, on.x = c("country", "days_since_100"), all.x = TRUE, all.y = FALSE)


```

### Comparisons with averages

```{r echo = FALSE, message=FALSE, warning=FALSE}
country_residuals <- seven_day_elasticity_by_country_no_outliers %>% mutate(ww_residual = lag_7_elasticity - prediction)  %>% arrange(days_since_100, ww_residual)

knitr::kable(country_residuals, caption = "Countries by Predicted vs. Actual Lag 7 New Case Elasticity on Today's Cases", digits  = 2)

```


## Forecast New Cases by Country

We estimate new cases by date, to see when countries will peak, based on the worldwide curve fit.

```{r echo = FALSE, message=FALSE, warning=FALSE}

non_na_countries <- covid_country_ets %>% group_by(country = Country_Region) %>% summarise(nonna_count = sum(!is.na(confirmed)))
non_na_countries <- non_na_countries %>% filter(nonna_count >= 20)

#Get country populations (2016 is latest data I can find easily)
country_pop <- read.csv("https://raw.githubusercontent.com/datasets/population/master/data/population.csv", stringsAsFactors = FALSE)
country_pop <- country_pop %>%  
  filter(Year == 2016) %>%
  select(country = Country.Name, population = Value)

country_pop$country[country_pop$country == "United States"] <- "US"

actuals <- covid_country_fc %>% 
  filter(Country_Region %in% non_na_countries$country) %>%
  select(country = Country_Region, date, days_since_100 = days_since_100, confirmed, new_confirmed, new_confirmed_ma7) 

prediction_ww <- expand.grid(country = unique(seven_day_elasticity_by_country$country), days_since_100 = 1:250) %>% 
  arrange(country, days_since_100) %>%
  filter(country %in% non_na_countries$country) %>%
  inner_join( country_pop, by = c("country" = "country")) 

prediction_ww$ww_coefficient <- cases_7_day_model_ww$coefficients[[1]] + cases_7_day_model_ww$coefficients[[2]] *                    log(prediction_ww$days_since_100)

country_residuals <- country_residuals %>% select(country, ww_residual)

prediction_ww <-  left_join(prediction_ww, country_residuals, by = c('country' = 'country')) 

# Try new model

covid_country_fc_p <- covid_country_fc %>% 
  group_by(Country_Region) %>% 
  mutate(lag7_elasticity = (log(new_confirmed_na)/ log(new_confirmed_lag7_na))) %>%
  filter(is.finite(lag7_elasticity))

cases_7_day_model_ww_2 <- lm(lag7_elasticity ~ log(days_since_100_na),data = covid_country_fc_p)

prediction_ww$new_ww_coefficient <- cases_7_day_model_ww_2$coefficients[[1]] + cases_7_day_model_ww_2$coefficients[[2]] *                    log(prediction_ww$days_since_100)

prediction_ww <- prediction_ww %>% mutate(ww_coefficient_adj = ww_coefficient + ww_residual, new_ww_coefficient_adj = new_ww_coefficient + ww_residual)

prediction_ww <- dplyr::left_join(prediction_ww, actuals, by = c('country', 'days_since_100')) 

sd_effect <- .03

# loop through df

for(i in 1:length(unique(prediction_ww$country))) {
  predict <- prediction_ww %>% filter(country == unique(prediction_ww$country)[i])
  predict$forecast_new <- round(forecast_forward(predict$new_confirmed, (predict$ww_coefficient_adj - sd_effect), 7, 
                                                 predict$population), digits = 0)
  if(i==1) {predict_df_ww <- predict} else {predict_df_ww <- rbind(predict_df_ww, predict)}
}

for(j in 1:length(unique(predict_df_ww$country))) {
  df_j <- predict_df_ww %>% filter(country == unique(predict_df_ww$country)[j])
  date_j <- date_forward(df_j$date)
  if(j==1) {complete_date <- date_j} else {complete_date <- c(complete_date, date_j)}
}

predict_df_ww$date <- complete_date

forecast_summary <- predict_df_ww %>% group_by(country) %>% 
  summarise(total_cases = sum(forecast_new), peak_new_cases = max(forecast_new)) 

max_date <- predict_df_ww %>% group_by(country) %>%
    slice(which.max(forecast_new)) %>% select(date)

forecast_summary <- merge(forecast_summary, max_date, on = "country")

forecast_summary <- forecast_summary %>% arrange(date)

forecast_summary <- forecast_summary %>% inner_join(country_pop, by = c("country" = "country"))  %>% mutate(perc_pop_infected = total_cases / population)

forecast_summary$perc_pop_infected <- scales::percent(forecast_summary$perc_pop_infected, accuracy = .1)
forecast_summary$total_cases <- scales::comma(forecast_summary$total_cases)
forecast_summary$peak_new_cases <- scales::comma(forecast_summary$peak_new_cases)
forecast_summary$population <- scales::comma(forecast_summary$population)

knitr::kable(forecast_summary, caption= "Forecast Peak New Cases by Country", align = c("l","r","r","r","r","r"), padding = 1
             )


```

## Forecast New Cases WW Total

```{r echo = FALSE, message=FALSE, warning=FALSE}

forecast_ww <- group_by(predict_df_ww, date) %>%
  summarise(forecast_new = sum(forecast_new)) %>%
  mutate(total_cases =  cumsum(forecast_new))

ggplot(forecast_ww[1:150,], aes(x=date, y=total_cases)) +
  geom_line() +
  ggtitle(paste0("WW Confirmed COVID19 Case Forecast as of ", format(Sys.time(), '%d %B %Y'))) + 
  scale_y_continuous(label=comma)

max_new <- forecast_ww[which.max(forecast_ww$forecast_new),]
max_new$forecast_new <- comma(max_new$forecast_new)
max_new$total_cases <- comma(max_new$total_cases)

knitr::kable(max_new, caption = "Peak Daily New Cases Worldwide and Total on That Day")

ggplot(forecast_ww[1:150,], aes(x=date, y=forecast_new)) +
  geom_line() +
  ggtitle(paste0("Worldwide New COVID19 Case Forecast as of ", format(Sys.time(), '%d %B %Y'))) + 
  scale_y_continuous(label=comma)


```


## Sparklines

### Confirmed Cases

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(covid_plm, aes(x=date, y=confirmed, group = Country_Region)) +
  geom_line() +
  facet_wrap(~ Country_Region) +
  ggtitle(paste0("Confirmed COVID19 Cases Through ", format(Sys.time(), '%d %B %Y'))) +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x=element_blank()) +
  theme(axis.title.x = element_blank())
```

### Deaths

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(covid_plm, aes(x=date, y=deaths, group = Country_Region)) +
  geom_line() +
  facet_wrap(~ Country_Region) +
  ggtitle(paste0("Cumulative COVID19 Deaths Through ", format(Sys.time(), '%d %B %Y'))) +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x=element_blank()) +
  theme(axis.title.x = element_blank())
```


### Confirmed Growth Rate 5-Day Moving Average

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(covid_plm, aes(x=date, y=conf_growth_rate_ma, group = Country_Region)) +
  geom_line() +
  facet_wrap(~ Country_Region) +
  ggtitle(paste0("5-Day MA Confirmed Growth Rate Through ", format(Sys.time(), '%d %B %Y'))) +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x=element_blank()) +
  theme(axis.title.x = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

### Death Rate 

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(covid_plm, aes(x=date, y=death_rate, group = Country_Region)) +
  geom_line() +
  facet_wrap(~ Country_Region) +
  ggtitle(paste0("Death Rate Through ", format(Sys.time(), '%d %B %Y'))) +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x=element_blank()) +
  theme(axis.title.x = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

# U.S. Analysis

```{r echo = FALSE, message=FALSE, warning=FALSE}
covid_ets_state <- data.frame(covid_ets)
covid_ets_state <- covid_ets %>% filter(Country_Region == "US") 

covid_ets_state <- covid_ets_state  %>% 
  group_by(Province_State, date) %>% 
  summarise(confirmed = sum(confirmed, na.rm=TRUE), deaths = sum(deaths, na.rm=TRUE), recovered=sum(recovered, na.rm=TRUE)) %>% 
  mutate(
    #create daily percent growth variables
    conf_growth_rate = c(NA,diff(confirmed))/lag(confirmed, 1),
    death_growth_rate = c(NA,diff(deaths))/lag(deaths, 1),
    death_rate = deaths / confirmed
   
  )

#replace NaNs w 0s
covid_ets_state$conf_growth_rate[is.nan(covid_ets_state$conf_growth_rate)] <- 0
covid_ets_state$death_growth_rate[is.nan(covid_ets_state$death_growth_rate)] <- 0

covid_ets_state <- covid_ets_state %>% mutate(
    #create daily percent growth variables
    confirmed_growth_rate = c(NA,diff(confirmed))/lag(confirmed, 1),
    death_growth_rate = c(NA,diff(deaths))/lag(deaths, 1),
    death_rate = deaths / confirmed,
    active = confirmed - deaths,
    active_lag14 = dplyr::lag(confirmed - deaths, 14, 0),
    active_lag7 = dplyr::lag(confirmed - deaths, 7, 0),
    confirmed_lag7 = dplyr::lag(confirmed, 7, 0),
    confirmed_lag14 = dplyr::lag(confirmed, 14, 0),
    new_confirmed = c(NA, diff(confirmed)),
    new_deaths = c(NA, diff(deaths)),
    new_confirmed_lag7 = dplyr::lag(new_confirmed,7,0),
    new_confirmed_lag14 = dplyr::lag(new_confirmed,14,0),
    new_confirmed_ma7 = rollmean(x=new_confirmed, 7, fill=NA, align = "right"),
    new_confirmed_ma14 = rollmean(x=new_confirmed, 14, fill=NA, align="right")) %>%
ungroup()

covid_ets_state <- covid_ets_state %>% mutate(
    conf_growth_rate_ma=rollapply(conf_growth_rate,5,mean,align='right',fill=NA),
    death_rate_ma=rollapply(death_rate,5,mean,align='right',fill=NA)) %>%
ungroup()


#Filter out growth w < 25 base
covid_ets_state$conf_growth_rate_ma[covid_ets_state$confirmed <100] <- NA
covid_ets_state$death_rate_ma[covid_ets_state$deaths <25] <- NA


#Only get states with >100 cases today
current_cases <- covid_ets_state %>% group_by(Province_State) %>% summarise(current_cases = max(confirmed, na.rm=TRUE))
hundred <- current_cases$Province_State[current_cases$current_cases >= 100]

covid_ets_state <- covid_ets_state %>% filter(Province_State %in% hundred)

#Create a panel data set
library(plm)
covid_plm_state <- pdata.frame(covid_ets_state, index=c("Province_State", "date"))
#create diff variables
covid_plm_state$diff_confirmed <- diff(covid_plm_state$confirmed, 1)
covid_plm_state$diff_deaths <- diff(covid_plm_state$deaths, 1)


```



## State Summary

Sorted by total number of cases. Percent growth in total cases in the past seven days is last column.

```{r echo = FALSE, message=FALSE, warning=FALSE}


#Only get state-days with >= 100 cases
covid_ets_state <- covid_ets_state %>% filter(confirmed >= 100, Province_State != "Grand Princess")
covid_ets_state <- covid_ets_state %>% group_by(Province_State) %>% mutate(days_since_100 = dplyr::row_number())


covid_ets_state$deaths_na <- covid_ets_state$deaths
covid_ets_state$deaths_na[covid_ets_state$deaths_na == 0] <- NA
covid_ets_state$confirmed_na <- covid_ets_state$confirmed
covid_ets_state$confirmed_na[covid_ets_state$confirmed_na == 0] <- NA
covid_ets_state$days_since_100_na <- covid_ets_state$days_since_100
covid_ets_state$days_since_100_na[covid_ets_state$days_since_100_na == 0] <- NA
covid_ets_state$active_lag14_na <- covid_ets_state$active_lag14
covid_ets_state$active_lag14_na[covid_ets_state$active_lag14_na == 0] <- NA
covid_ets_state$active_lag7_na <- covid_ets_state$active_lag7
covid_ets_state$active_lag7_na[covid_ets_state$active_lag7_na == 0] <- NA
covid_ets_state$confirmed_lag7_na <- covid_ets_state$confirmed_lag7
covid_ets_state$confirmed_lag7_na[covid_ets_state$confirmed_lag7_na == 0] <- NA
covid_ets_state$confirmed_lag14_na <- covid_ets_state$confirmed_lag14
covid_ets_state$confirmed_lag14_na[covid_ets_state$confirmed_lag14_na == 0] <- NA
covid_ets_state$new_confirmed_lag7_na <- covid_ets_state$new_confirmed_lag7
covid_ets_state$new_confirmed_lag7_na[covid_ets_state$new_confirmed_lag7_na == 0] <- NA
covid_ets_state$new_confirmed_lag14_na <- covid_ets_state$new_confirmed_lag14
covid_ets_state$new_confirmed_lag14_na[covid_ets_state$new_confirmed_lag14_na == 0] <- NA
covid_ets_state$new_confirmed_na <- covid_ets_state$new_confirmed
covid_ets_state$new_confirmed_na[covid_ets_state$new_confirmed_na == 0] <- NA
covid_ets_state$new_confirmed_lag7_na <- covid_ets_state$new_confirmed_lag7
covid_ets_state$new_confirmed_lag7_na[covid_ets_state$new_confirmed_lag7_na == 0] <- NA
covid_ets_state$new_confirmed_lag14_na <- covid_ets_state$new_confirmed_lag14
covid_ets_state$new_confirmed_lag14_na[covid_ets_state$new_confirmed_lag14_na == 0] <- NA
covid_ets_state$new_confirmed_ma7_na <- covid_ets_state$new_confirmed_ma7
covid_ets_state$new_confirmed_ma7_na[covid_ets_state$new_confirmed_ma7_na == 0] <- NA
covid_ets_state$new_confirmed_ma14_na <- covid_ets_state$new_confirmed_ma14
covid_ets_state$new_confirmed_ma14_na[covid_ets_state$new_confirmed_ma14_na == 0] <- NA

days_since_100_by_state <- covid_ets_state %>% group_by(Province_State) %>% summarize(days_since_100 = max(days_since_100))

state_summary <- covid_ets_state %>%
  group_by(Province_State) %>% 
  slice(which.max(days_since_100)) %>% 
  select(Province_State, days_100 = days_since_100, conf = confirmed, deaths, new_conf=new_confirmed, conf_lag7=confirmed_lag7) %>%
  arrange(desc(conf))

us <- data.frame(Province_State = "US", 
                 days_100 = mean(state_summary$days_100),
                 conf = sum(state_summary$conf),
                 deaths = sum(state_summary$deaths),
                 new_conf = sum(state_summary$new_conf),
                 conf_lag7 = sum(state_summary$conf_lag7))

state_summary <- bind_rows(state_summary, us)   

state_summary <- state_summary %>% mutate(l7_rate = (conf / conf_lag7)-1, death_rate = deaths / conf)

require(scales)
state_summary$l7_rate <- scales::percent(state_summary$l7_rate, big.mark = ",")
state_summary$death_rate <- scales::percent(state_summary$death_rate, accuracy = .01, big.mark = ",")


knitr::kable(state_summary, caption = "State-by-State Summary", digits  = 0, align = c("l",rep("r", times = 8)))

```

## Ln (Seven-Day-Moving-Average New Cases) Impact on Ln (New Cases)

In other words, elasticity. How does this elasticity change through time, from days since the 50th case?

An elasticity under 1 indicates that over a seven-day period, new cases are decreasing.

The black line is the best fit for elasticity for the states that have had 100 cases as they progress. Above the line: worse than average; below-the-line: better than average.

The blue line is the best fit for elasticity for countries across the world. It's apparent that the U.S. is not doing as well as the rest of the world in containing exponential growth--probably due to initial testing failures.

```{r echo = FALSE, message=FALSE, warning=FALSE}
library(broom)
#Remove NAs

confirmed_models <- covid_ets_state %>% group_by(Province_State) %>% do(model = lm(log(new_confirmed_na) ~  log(new_confirmed_ma7_na) -1, data = .))
confirmed_tidy_model <- confirmed_models %>% tidy(model)

seven_day_elasticity_by_state <- data.frame(state = confirmed_tidy_model$Province_State, days_since_100  = as.numeric(days_since_100_by_state$days_since_100), lag_7_elasticity = confirmed_tidy_model$estimate)


cases_7_day_model_us <- lm(lag_7_elasticity ~ log(days_since_100),data = seven_day_elasticity_by_state)

seven_day_elasticity_by_state$prediction_us <-  cases_7_day_model_us$coefficients[[1]] + cases_7_day_model_us$coefficients[[2]] * log(seven_day_elasticity_by_state$days_since_100)

seven_day_elasticity_by_state$prediction_ww <-  cases_7_day_model_ww$coefficients[[1]] + cases_7_day_model_ww$coefficients[[2]] * log(seven_day_elasticity_by_state$days_since_100)

seven_day_elasticity_by_state_no_outliers <- seven_day_elasticity_by_state %>% filter(lag_7_elasticity <2)
  
require(ggrepel)
ggplot(seven_day_elasticity_by_state_no_outliers, aes(x=days_since_100)) +
    geom_point(shape=1, show.legend = FALSE, (aes(y=lag_7_elasticity, color = state))) +    # Use hollow circles
      geom_line(aes( y = prediction_us), color = "black") +
      geom_line(aes( y = prediction_ww), color = "blue") +
   geom_label_repel(data=  seven_day_elasticity_by_state_no_outliers, aes(x=days_since_100, y=lag_7_elasticity, label = state), size=2) + 
    theme(legend.position = "none") 

```

### Comparisons with U.S. and worldwide averages

Some states are doing better than worldwide averages when taking into account days since 100th case. Most are doing worse.

```{r echo = FALSE, message=FALSE, warning=FALSE}
state_residuals <- seven_day_elasticity_by_state_no_outliers %>% mutate(us_residual = lag_7_elasticity - prediction_us, ww_residual = lag_7_elasticity - prediction_ww) %>% arrange(days_since_100, us_residual)

knitr::kable(state_residuals, caption = "States by Predicted vs. Actual Lag 7 New Case Elasticity on Today's Cases", digits  = 2)

```

## Forecast New Cases by State

We estimate new cases by date, to see when states will peak, based on the worldwide curve fit. The reasoning is that testing rates increasing wildly recently in the U.S. have falsely inflated elasticity.

```{r echo = FALSE, message=FALSE, warning=FALSE}

non_na_states <- covid_ets_state %>% group_by(Province_State) %>% summarise(nonna_count = sum(!is.na(confirmed)))
non_na_states <- non_na_states %>% filter(nonna_count > 7)

#Get state populations--only have through 2013 for now, need to update
state_pop <- read.csv("https://raw.githubusercontent.com/jakevdp/data-USstates/master/state-population.csv", stringsAsFactors = FALSE)
state_pop <- state_pop %>%  filter(ages == "total", year == 2013)
state_pop <- dplyr::inner_join(state_pop, state_key_o, by = c("state.region" = "Abbreviation"))



actuals <- covid_ets_state %>% 
  filter(Province_State %in% non_na_states$Province_State) %>%
  select(state = Province_State, date, days_since_100 = days_since_100, confirmed, new_confirmed, new_confirmed_ma7) 


prediction_us <- expand.grid(state = unique(seven_day_elasticity_by_state$state), days_since_100 = 1:200) %>% 
  arrange(state, days_since_100) %>%
  filter(state %in% non_na_states$Province_State) %>%
  inner_join( state_pop, by = c("state" = "State")) 

prediction_us$us_coefficient <- cases_7_day_model_us$coefficients[[1]] + cases_7_day_model_us$coefficients[[2]] *                    log(prediction_us$days_since_100)

prediction_us$ww_coefficient <- cases_7_day_model_ww$coefficients[[1]] + cases_7_day_model_ww$coefficients[[2]] *                    log(prediction_us$days_since_100)

state_residuals <- state_residuals %>% select(state, us_residual, ww_residual)

prediction_us<-  left_join(prediction_us, state_residuals, by = c('state' = 'state')) 

# Try new model

covid_ets_state_p <- covid_ets_state %>% group_by(Province_State) %>% mutate(lag7_elasticity = (log(new_confirmed_na)/ log(new_confirmed_lag7_na))) %>% filter(is.finite(lag7_elasticity))

cases_7_day_model_us_2 <- lm(lag7_elasticity ~ log(days_since_100_na),data = covid_ets_state_p)

prediction_us$new_us_coefficient <- cases_7_day_model_us_2$coefficients[[1]] + cases_7_day_model_us_2$coefficients[[2]] *                    log(prediction_us$days_since_100)

prediction_us <- prediction_us %>% mutate(us_coefficient_adj = us_coefficient + us_residual, ww_coefficient_adj = ww_coefficient + ww_residual, new_us_coefficient_adj = new_us_coefficient + us_residual)

prediction_us <- dplyr::left_join(prediction_us, actuals, by = c('state', 'days_since_100')) 


# loop through df

social_distancing_effect <- .02

for(i in 1:length(unique(prediction_us$state))) {
  predict <- prediction_us %>% filter(state == unique(prediction_us$state)[i])
  predict$forecast_new <- round(forecast_forward(predict$new_confirmed, (predict$ww_coefficient_adj - social_distancing_effect), 7, predict$population), digits = 0)
  if(i==1) {predict_df <- predict} else {predict_df <- rbind(predict_df, predict)}
}

for(j in 1:length(unique(predict_df$state))) {
  df_j <- predict_df %>% filter(state == unique(predict_df$state)[j])
  date_j <- date_forward(df_j$date)
  if(j==1) {complete_date <- date_j} else {complete_date <- c(complete_date, date_j)}
}

predict_df$date <- complete_date

predict_df <- predict_df %>% 
  group_by(state) %>%
  mutate(new_cases_lag = dplyr::lag(forecast_new, 3,0)) %>%
  mutate(deaths_new = new_cases_lag * .04)

forecast_summary <- predict_df %>% group_by(state) %>% 
  summarise(total_cases = sum(forecast_new), total_deaths = sum(deaths_new), peak_new_cases = max(forecast_new), peak_new_deaths = round(max(deaths_new),0))

max_date_new <- predict_df %>% group_by(state) %>%
    slice(which.max(forecast_new)) %>% select(max_new_date = date)

max_date_death <- predict_df %>% group_by(state) %>%
    slice(which.max(deaths_new)) %>% select(max_death_date = date)

forecast_summary <- merge(forecast_summary, max_date_new, on = "state")
forecast_summary <- merge(forecast_summary, max_date_death, on = "state")
forecast_summary <- forecast_summary %>% arrange(max_new_date)



forecast_summary <- forecast_summary %>% inner_join(state_pop, by = c("state" = "State")) %>% select(-state.region, -ages, -year) %>% mutate(perc_pop_infected = total_cases / population)

forecast_summary$perc_pop_infected <- scales::percent(forecast_summary$perc_pop_infected, accuracy = .1)
forecast_summary$total_cases <- scales::comma(forecast_summary$total_cases)
forecast_summary$total_deaths <- scales::comma(forecast_summary$total_deaths)
forecast_summary$peak_new_cases <- scales::comma(forecast_summary$peak_new_cases)
forecast_summary$peak_new_deaths <- scales::comma(forecast_summary$peak_new_deaths)
forecast_summary$population <- scales::comma(forecast_summary$population)

knitr::kable(forecast_summary %>% select(-total_cases, -total_deaths, -perc_pop_infected), caption= "Forecast Peak New Cases by State", align = c("l","r","r","r","r","r"), col.names = c("State",  "Peak Cases", "Peak Deaths", "Max Case Date", "Max Death Date", "Population"))

knitr::kable(forecast_summary %>% select(state, total_cases, total_deaths, population, perc_pop_infected), caption= "Forecast Total New Cases by State", align = c("l","r","r","r","r"), col.names = c("State",  "Total Cases", "Total Deaths", "Population", "% Population Infected"))


```

## Forecast New Cases U.S. Total

```{r echo = FALSE, message=FALSE, warning=FALSE}

forecast_us <- group_by(predict_df, date) %>%
  summarise(forecast_new = sum(forecast_new), deaths_new = sum(deaths_new)) %>%
  mutate(total_cases =  cumsum(forecast_new), total_deaths =cumsum(deaths_new))

ggplot(forecast_us[1:150,], aes(x=date, y=total_cases)) +
  geom_line() +
  ggtitle(paste0("U.S. Confirmed COVID19 Case Forecast as of ", format(Sys.time(), '%d %B %Y'))) + 
  scale_y_continuous(label=comma)

max_new <- forecast_us[which.max(forecast_us$forecast_new),]
max_new$forecast_new <- comma(max_new$forecast_new)
max_new$total_cases <- comma(max_new$total_cases)

knitr::kable(max_new, caption = "Peak Daily New Cases in U.S. and Total on That Day")

ggplot(forecast_us[1:150,], aes(x=date, y=forecast_new)) +
  geom_line() +
  ggtitle(paste0("U.S. New COVID19 Case Forecast as of ", format(Sys.time(), '%d %B %Y'))) + 
  scale_y_continuous(label=comma)


max_new_deaths <- forecast_us[which.max(forecast_us$deaths_new),]
max_new_deaths$deaths_new <- comma(max_new_deaths$deaths_new)
max_new_deaths$total_cases <- comma(max_new_deaths$total_cases)

knitr::kable(max_new_deaths, caption = "Peak Daily Deaths in U.S. and Total on That Day")


ggplot(forecast_us[1:150,], aes(x=date, y=total_deaths)) +
  geom_line() +
  ggtitle(paste0("U.S. COVID19 Death Forecast as of ", format(Sys.time(), '%d %B %Y'))) + 
  scale_y_continuous(label=comma)


```


## Sparklines

We only look at states with more than one hundred cases today. For moving average growth rates, we only look at states with deaths and recoveries over 25.

### Confirmed Cases

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(covid_plm_state, aes(x=date, y=confirmed, group = Province_State)) +
  geom_line() +
  facet_wrap(~ Province_State) +
  ggtitle(paste0("Confirmed COVID19 Cases Through ", format(Sys.time(), '%d %B %Y'))) +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x=element_blank()) +
  theme(axis.title.x = element_blank())
```

### Deaths

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(covid_plm_state, aes(x=date, y=deaths, group = Province_State)) +
  geom_line() +
  facet_wrap(~ Province_State) +
  ggtitle(paste0("Cumulative COVID19 Deaths Through ", format(Sys.time(), '%d %B %Y'))) +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x=element_blank()) +
  theme(axis.title.x = element_blank())
```


### Confirmed Growth Rate 5-Day Moving Average

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(covid_plm_state, aes(x=date, y=conf_growth_rate_ma, group = Province_State)) +
  geom_line() +
  facet_wrap(~ Province_State) +
  ggtitle(paste0("Confirmed Growth Rate Through ", format(Sys.time(), '%d-1 %B %Y'))) +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x=element_blank()) +
  theme(axis.title.x = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

### Death Rate 5-Day Moving Average

Only states with >25 deaths are shown

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(covid_plm_state, aes(x=date, y=death_rate_ma, group = Province_State)) +
  geom_line() +
  facet_wrap(~ Province_State) +
  ggtitle(paste0("Death Rate Through " , format(Sys.time(), '%d-1 %B %Y'))) +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x=element_blank()) +
  theme(axis.title.x = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```


### Log / Time for States After 100th Case

```{r echo = FALSE, message=FALSE, warning=FALSE}
covid_plm_state_log <- covid_plm_state %>%
  filter(confirmed >=100) %>% 
  mutate(confirmed_log = log10(confirmed), deaths_log = log10(deaths)) %>%
  group_by(Province_State) %>% 
  mutate(days_since_100 = dplyr::row_number())

```

### Log-10 by States: Confirmed Cases by Day After 50th Confirmed Case

```{r echo = FALSE, message=FALSE, warning=FALSE}
require(scales)
ggplot(covid_plm_state_log, aes(x=days_since_100, y=confirmed_log, group = Province_State, color = Province_State)) +
  geom_line(show.legend = FALSE) +
  facet_wrap(~ Province_State) +
  ggtitle(paste0("Log-10 of Confirmed Cases Since 100th Case by State as of ", format(Sys.time(), '%d %B %Y'))) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
  labels = trans_format("log10", math_format(10^.x)))
```

## Zero at Fifty Cases

### Confirmed Cases

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(covid_ets_state, aes(x=days_since_100_na, y=confirmed, group = Province_State, color = Province_State)) +
  geom_line() +
  scale_y_continuous(labels = comma) +
  ggtitle(paste0("Confirmed COVID19 Cases by State Through ", format(Sys.time(), '%d %B %Y'))) +
  theme(legend.position = "none") +
  geom_text(data = covid_ets_state %>% group_by(Province_State) %>% filter(days_since_100_na == last(days_since_100_na)), aes(label=Province_State, x = days_since_100_na + 1, y=confirmed, color = Province_State), size = 2)
```


# Testing Data

```{r echo = FALSE, message=FALSE, warning=FALSE}
state_historical_testing_df <- read.csv("https://covidtracking.com/api/v1/states/daily.csv") 
state_current_testing_df <- read.csv("https://covidtracking.com/api/v1/states/current.csv") 

state_historical_testing_df$date <- lubridate::ymd(state_historical_testing_df$date)

state_historical_testing_df <- state_historical_testing_df %>%  mutate(instant_positive_rate = positiveIncrease / totalTestResultsIncrease)
state_current_testing_df <- state_current_testing_df %>% mutate(positive_rate = positive/  totalTestResults)

us_testing_df <- state_historical_testing_df %>% 
  group_by(date) %>% 
  summarise(positiveIncrease = sum(positiveIncrease),
            totalTestResultsIncrease = sum(totalTestResultsIncrease)) %>%
  mutate(instant_positive_rate = positiveIncrease / totalTestResultsIncrease, state = "US-Total")

testing_df <- bind_rows(state_historical_testing_df, us_testing_df)

testing_df_dd <- testing_df %>% filter(state %in% c("NY", "WA", "LA", "MI", "US-Total"), instant_positive_rate <1)

```

## State-by-State Testing Summary

States are sorted descending by total tested. Cum Pos Rate is the cumulative positive rate since the pandemic began; instant positive rate is the current daily testing rate. Instant positive trend is instant positive rate / cumulative positive rate.

```{r echo = FALSE, message=FALSE, warning=FALSE}
state_current_testing_summary <- state_historical_testing_df %>% 
  group_by(state) %>%
  filter(date == max(date)) %>%
  mutate(instant_positive_rate = positiveIncrease / totalTestResultsIncrease,
         positive_rate = positive/  totalTestResults, 
         instant_positive_trend = (instant_positive_rate / positive_rate) -1) %>%
  select(state, positive, totalTestResults, positive_rate, positiveIncrease, totalTestResultsIncrease, instant_positive_rate,
         instant_positive_trend) %>%
  arrange(desc(totalTestResults))

state_current_testing_summary$instant_positive_rate <- scales::percent(state_current_testing_summary$instant_positive_rate, accuracy = 0.1)
state_current_testing_summary$positive_rate <- scales::percent(state_current_testing_summary$positive_rate, accuracy = 0.1)
state_current_testing_summary$instant_positive_trend <- scales::percent(state_current_testing_summary$instant_positive_trend, accuracy = .1)
state_current_testing_summary$positive <- scales::comma(state_current_testing_summary$positive)
state_current_testing_summary$totalTestResults <- scales::comma(state_current_testing_summary$totalTestResults)
state_current_testing_summary$positiveIncrease <- scales::comma(state_current_testing_summary$positiveIncrease)
state_current_testing_summary$totalTestResultsIncrease <- scales::comma(state_current_testing_summary$totalTestResultsIncrease)


knitr::kable(state_current_testing_summary, caption = "State-by-State Testing Summary", align = c("l",rep("r", times = ncol(state_current_testing_summary) -1)), col.names=c("State", "Pos", "Cum Tested", "Cum Pos Rate", "Pos Increase", "Tested Increase", "Instant Pos Rate", "Instant Pos Trend"))

ggplot(testing_df_dd, aes(x = date, y= instant_positive_rate, group = state, color = state)) +
  geom_line() +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  ggtitle(paste0("U.S. and Selected State Instant Positive Test Rate as of ", format(Sys.time(), '%d %B %Y'))) +
  theme(legend.position = "none") +
  geom_text(data = testing_df_dd %>% group_by(state) %>% filter(date == max(date)), aes(label=paste0(state, " ", scales::percent(instant_positive_rate, accuracy = .01)), x = date + 1, y= instant_positive_rate, color = state), size = 2)

```

## Hospitalization Summary

State-by-state hospitalization data are still VERY spotty as of April 5th. Most states are not reporting.

```{r echo = FALSE, message=FALSE, warning=FALSE}
state_current_hospitalized_summary <- state_current_testing_df %>% 
  select(state, positive, hospitalizedCurrently, inIcuCurrently, recovered, death) %>% 
  mutate(perc_hospitalized = hospitalizedCurrently / positive, 
         perc_icu = inIcuCurrently / hospitalizedCurrently, 
         perc_recovered = recovered / positive,
         perc_death= death / positive) %>%
  arrange(desc(hospitalizedCurrently))
  
state_current_hospitalized_summary$perc_hospitalized <- scales::percent(state_current_hospitalized_summary$perc_hospitalized, accuracy = 0.1)
state_current_hospitalized_summary$perc_icu <- scales::percent(state_current_hospitalized_summary$perc_icu, accuracy = 0.1)
state_current_hospitalized_summary$perc_recovered <- scales::percent(state_current_hospitalized_summary$perc_recovered, accuracy = .1)
state_current_hospitalized_summary$perc_death <- scales::percent(state_current_hospitalized_summary$perc_death, accuracy = .1)

state_current_hospitalized_summary$positive <- scales::comma(state_current_hospitalized_summary$positive)
state_current_hospitalized_summary$hospitalizedCurrently <- scales::comma(state_current_hospitalized_summary$hospitalizedCurrently)
state_current_hospitalized_summary$inIcuCurrently <- scales::comma(state_current_hospitalized_summary$inIcuCurrently)
state_current_hospitalized_summary$recovered <- scales::comma(state_current_hospitalized_summary$recovered)
state_current_hospitalized_summary$death <- scales::comma(state_current_hospitalized_summary$death)
  
knitr::kable(state_current_hospitalized_summary, 
             caption = "State-by-State Hospitalization and ICU Data", 
             align = c("l", rep("r", times = ncol(state_current_hospitalized_summary) -1)), 
             col.names = c("State", "Positive", "Hospitalized", "In ICU", "Recovered", "Dead", "% Hospitalized", "% ICU (of Hospitalized)", "% Recovered", "% Death"))

```

## Selected States Drill-Down

New York State has been the U.S. epicenter so far. New York is also testing much more than most states, but at the same time, its positive rate is very high (around 50% as of early March), indicating that people being tested are high-likelihood cases; as such it should be assumed that there remain a very large population of untested positive patients.

The DMV (D.C., Maryland, Virginia) might be a coming hotspot. Watching instant positive test rates will be a key leading indicator of hospitalizations and ICU beds in the coming week.

```{r echo = FALSE, message=FALSE, warning=FALSE}

ny_df <- state_historical_testing_df %>% 
  filter(state %in% c("NY"))


dmv_df <- state_historical_testing_df %>% 
  filter(state %in% c("MD", "VA", "DC"), instant_positive_rate < 1)
nyc_df <- state_historical_testing_df %>% 
  filter(state %in% c("NY", "CT", "NJ"), instant_positive_rate < 1)

ggplot(dmv_df, aes(x = date, y= totalTestResultsIncrease, group = state, color = state)) +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(0,5000)) +
  ggtitle(paste0("New Tests as of ", format(Sys.time(), '%d %B %Y'), ", DMV Area")) +
  theme(legend.position = "none") +
  geom_text(data = dmv_df %>% group_by(state) %>% filter(date == max(date)), aes(label=state, x = date + 1, y= totalTestResultsIncrease, color = state), size = 2)

ggplot(dmv_df, aes(x = date, y= instant_positive_rate, group = state, color = state)) +
  geom_line() +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  ggtitle(paste0("Instant Positive Test Rate as of ", format(Sys.time(), '%d %B %Y'), ", DMV Area")) +
  theme(legend.position = "none") +
  geom_text(data = dmv_df %>% group_by(state) %>% filter(date == max(date)), aes(label=state, x = date + 1, y= instant_positive_rate, color = state), size = 2)

ggplot(nyc_df, aes(x = date, y= totalTestResultsIncrease, group = state, color = state)) +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(0,50000)) +
  ggtitle(paste0("New Tests as of ", format(Sys.time(), '%d %B %Y'), ", NYC Area")) +
  theme(legend.position = "none") +
  geom_text(data = nyc_df %>% group_by(state) %>% filter(date == max(date)), aes(label=state, x = date + 1, y= totalTestResultsIncrease, color = state), size = 2)

ggplot(nyc_df, aes(x = date, y= instant_positive_rate, group = state, color = state)) +
  geom_line() +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  ggtitle(paste0("Instant Positive Test Rate as of ", format(Sys.time(), '%d %B %Y'), ", NYC Area")) +
  theme(legend.position = "none") +
  geom_text(data = nyc_df %>% group_by(state) %>% filter(date == max(date)), aes(label=state, x = date + 1, y= instant_positive_rate, color = state), size = 2)

ggplot(ny_df, aes(x = date , y = deathIncrease)) +
  geom_line() +
  scale_y_continuous(labels = comma) +
  ggtitle(paste0("New Deaths as of ", format(Sys.time(), '%d %B %Y'), ", NY")) +
  theme(legend.position = "none") +
  geom_text(data = ny_df %>% filter(date == max(date)), aes(label=deathIncrease, x = date + 1, y= deathIncrease), size = 2)

ggplot(ny_df, aes(x = date , y = inIcuCurrently)) +
  geom_line() +
  scale_y_continuous(labels = comma) +
  ggtitle(paste0("In ICU as of ", format(Sys.time(), '%d %B %Y'), ", NY")) +
  theme(legend.position = "none") +
  geom_text(data = ny_df %>% filter(date == max(date)), aes(label=inIcuCurrently, x = date + 1, y= inIcuCurrently), size = 2)

ggplot(ny_df, aes(x = date , y = hospitalizedCurrently)) +
  geom_line() +
  scale_y_continuous(labels = comma) +
  ggtitle(paste0("Hospitalized as of ", format(Sys.time(), '%d %B %Y'), ", NY")) +
  theme(legend.position = "none") +
  geom_text(data = ny_df %>% filter(date == max(date)), aes(label=hospitalizedCurrently, x = date + 1, y= hospitalizedCurrently), size = 2)


```